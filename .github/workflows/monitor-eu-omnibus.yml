name: Monitor EU Digital Omnibus

on:
  schedule:
    # Run every hour
    - cron: '0 * * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  monitor:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check EU Digital Strategy Portal
        id: check_digital_strategy
        run: |
          curl -s "https://digital-strategy.ec.europa.eu/en/news" -o page.html
          if grep -q "Digital Omnibus" page.html; then
            echo "found=true" >> $GITHUB_OUTPUT
            echo "source=EU Digital Strategy Portal" >> $GITHUB_OUTPUT
          else
            echo "found=false" >> $GITHUB_OUTPUT
          fi

      - name: Check EUR-Lex for Digital Omnibus Proposals
        id: check_eurlex
        run: |
          # Check EUR-Lex for recent Digital Omnibus proposals
          curl -s "https://eur-lex.europa.eu/search.html?qId=1700000000000&scope=EUR-LEX&type=advanced&lang=en&PRO_APREQ=Digital%20Omnibus" -o eurlex.html
          if grep -q "Digital Omnibus" eurlex.html; then
            echo "found=true" >> $GITHUB_OUTPUT
            echo "source=EUR-Lex" >> $GITHUB_OUTPUT
          else
            echo "found=false" >> $GITHUB_OUTPUT
          fi

      - name: Create summary
        run: |
          echo "## Regulatory Monitor Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Last Check:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Digital Omnibus Status" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check_digital_strategy.outputs.found }}" = "true" ] || [ "${{ steps.check_eurlex.outputs.found }}" = "true" ]; then
            echo "✅ **FOUND** - Digital Omnibus documentation detected!" >> $GITHUB_STEP_SUMMARY
            if [ "${{ steps.check_digital_strategy.outputs.found }}" = "true" ]; then
              echo "- Found on: EU Digital Strategy Portal" >> $GITHUB_STEP_SUMMARY
            fi
            if [ "${{ steps.check_eurlex.outputs.found }}" = "true" ]; then
              echo "- Found on: EUR-Lex" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "❌ Not yet released - Still monitoring" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Update RSS feed
        run: |
          python3 << 'EOF'
          import xml.etree.ElementTree as ET
          from datetime import datetime
          import os

          # Determine if found
          found = "${{ steps.check_digital_strategy.outputs.found }}" == "true" or "${{ steps.check_eurlex.outputs.found }}" == "true"

          # Create RSS feed entry
          timestamp = datetime.utcnow().isoformat() + 'Z'
          status = "✅ FOUND" if found else "❌ Still monitoring"

          description = f"""
          <p><strong>Status:</strong> {status}</p>
          <p><strong>Digital Strategy Portal:</strong> {'Found' if "${{ steps.check_digital_strategy.outputs.found }}" == "true" else 'Not found'}</p>
          <p><strong>EUR-Lex:</strong> {'Found' if "${{ steps.check_eurlex.outputs.found }}" == "true" else 'Not found'}</p>
          <p><a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}">View workflow run</a></p>
          """

          # Load or create RSS feed
          rss_file = 'feed.xml'
          if os.path.exists(rss_file):
            tree = ET.parse(rss_file)
            root = tree.getroot()
          else:
            root = ET.Element('rss', version='2.0')
            channel = ET.SubElement(root, 'channel')
            ET.SubElement(channel, 'title').text = 'Regulatory Monitor - EU Digital Omnibus'
            ET.SubElement(channel, 'link').text = 'https://github.com/${{ github.repository }}'
            ET.SubElement(channel, 'description').text = 'Monitoring for EU Digital Omnibus updates'
            tree = ET.ElementTree(root)

          # Get channel and add new item at the beginning
          channel = root.find('channel')

          # Create new item
          item = ET.Element('item')
          ET.SubElement(item, 'title').text = f"Monitor Run - {status}"
          ET.SubElement(item, 'description').text = description
          ET.SubElement(item, 'pubDate').text = timestamp
          ET.SubElement(item, 'link').text = f"https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          # Insert at beginning
          channel.insert(0, item)

          # Keep only last 50 items
          items = channel.findall('item')
          while len(items) > 50:
            channel.remove(items[-1])
            items = channel.findall('item')

          # Write feed
          tree.write(rss_file, encoding='utf-8', xml_declaration=True)
          EOF

      - name: Commit RSS feed
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add feed.xml
          git commit -m "Update RSS feed - $(date -u +'%Y-%m-%d %H:%M:%S UTC')" || echo "No changes to commit"
          git push || echo "Nothing to push"
